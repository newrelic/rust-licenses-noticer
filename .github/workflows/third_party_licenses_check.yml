permissions:
  contents: read
on:
  push:
# See https://docs.github.com/en/actions/using-jobs/using-concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
name: ⚖️ Third party licenses
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Retrieve dependencies with cargo deny
        run: >
          cargo deny
          --all-features
          --log-level off
          --manifest-path ./Cargo.toml
          list
          -l crate
          -f json > dependencies.json

      - name: Perform the third party licenses check
        run: >
          cargo run --manifest-path ./Cargo.toml
          --
          --dependencies "$(cat dependencies.json)"
          --output-file "./THIRD_PARTY_NOTICES.md"
          --templates-path "./third_party_licenses_templates/*"

      - name: Check if `THIRD_PARTY_NOTICES.md` was up to date
        run: >
          git diff --name-only
          | grep -q "THIRD_PARTY_NOTICES.md"
          && { 
            echo "Third party notices out of date.
            Please run rust-licenses-noticer in this repo and commit the changes in this PR.";
            exit 1;
          }
          || echo "Third party notices up to date."

