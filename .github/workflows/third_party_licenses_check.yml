permissions:
  contents: read
on:
  push:
# See https://docs.github.com/en/actions/using-jobs/using-concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
name: ⚖️ Third party licenses
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Retrieve dependencies with cargo deny
        run: >
          cargo deny
          --all-features
          --log-level off
          --manifest-path ./Cargo.toml
          list
          -l crate
          -f json > dependencies.json

      - name: Perform the third party licenses check
        run: >
          cargo run --manifest-path ./Cargo.toml
          --
          --dependencies "$(cat dependencies.json)"
          --output-file "./THIRD_PARTY_NOTICES.md"
          --template-path "./THIRD_PARTY_NOTICES.md.tmpl"

      - name: Check if the notices file was up to date
        run: |
          STATUS=$(git status --porcelain --untracked-files=all -- ./THIRD_PARTY_NOTICES.md)

          if [[ "$STATUS" =~ ^\?\? ]]; then
            echo "::error file=./THIRD_PARTY_NOTICES.md,title=untracked-file::Notices file was created. Please run rust-licenses-noticer locally and commit the changes."
            exit 1
          elif [[ "$STATUS" =~ ^\\sM ]]; then
            echo "::error file=./THIRD_PARTY_NOTICES.md,title=modified-file::Notices file was modified. Please run rust-licenses-noticer locally and commit the changes."
            exit 1
          else
            echo "Third party notices up to date."
          fi

